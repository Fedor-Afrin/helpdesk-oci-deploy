{% extends "base.html" %}

{% block content %}
<div class="ticket-header">
    <a href="{{ url_for('dashboard') }}" class="back-link">← Назад к списку</a>
    {# ИСПРАВЛЕНО: Обращение к полям тикета как к словарю #}
    <h2>#{{ ticket['id'] or ticket.id }} {{ ticket['title'] or ticket.title }}</h2>
    <div class="ticket-meta">
        <p><strong>Создано:</strong> {{ (ticket['created_at'] or ticket.created_at)[:16]|replace('T', ' ') if
            (ticket['created_at'] or ticket.created_at) else '-' }}</p>
        <p><strong>Описание:</strong> {{ ticket['description'] or ticket.description }}</p>
        <p><strong>Статус:</strong> <span class="badge {{ ticket['status'] or ticket.status }}">{{ ticket['status'] or
                ticket.status }}</span></p>
    </div>
</div>

<hr>

{% if session.is_staff or session.is_admin %}
<div class="status-update-box">
    <h4>Обновить статус заявки</h4>
    <form action="{{ url_for('update_ticket', ticket_id=ticket['id'] or ticket.id) }}" method="post"
        class="inline-form">
        <select name="status">
            <option value="new" {% if (ticket['status'] or ticket.status)=='new' %}selected{% endif %}>Новая</option>
            <option value="in_progress" {% if (ticket['status'] or ticket.status)=='in_progress' %}selected{% endif %}>В
                работе</option>
            <option value="closed" {% if (ticket['status'] or ticket.status)=='closed' %}selected{% endif %}>Закрыта
            </option>
        </select>
        <button type="submit" class="btn-primary">Применить</button>
    </form>
</div>
{% endif %}

<div class="reports-section">
    <h3>Отчеты о работе и файлы</h3>

    <div class="reports-list">
        {% for report in reports %}
        <div class="report-card">
            {# ИСПРАВЛЕНО: Синтаксис словаря для комментариев #}
            <p>{{ report['comment'] or report.comment }}</p>

            {# ИСПРАВЛЕНО: Проверка наличия файла через ключ словаря #}
            {% set f_path = report['file_path'] or report.file_path %}
            {% if f_path %}
            <div class="file-link">
                <a href="{{ url_for('serve_media', filename=f_path) }}" target="_blank">
                    <i class="fas fa-paperclip"></i> Скачать файл ({{ f_path }})
                </a>
            </div>
            {% endif %}

            <small class="text-muted">
                {{ (report['created_at'] or report.created_at)[:16]|replace('T', ' ') if (report['created_at'] or
                report.created_at) else '' }}
            </small>
        </div>
        {% else %}
        <p>Отчетов пока нет.</p>
        {% endfor %}
    </div>

    <hr>

    <div class="add-report">
        <h4>Добавить отчет о проделанной работе</h4>
        <form action="{{ url_for('add_report', ticket_id=ticket['id'] or ticket.id) }}" method="post"
            enctype="multipart/form-data">
            <textarea name="comment" placeholder="Опишите, что было сделано..." required></textarea>

            <div class="file-upload-wrapper">
                <label for="file-upload" class="custom-file-upload">
                    <i class="fas fa-paperclip"></i> Прикрепить файл
                </label>
                <input id="file-upload" type="file" name="file" onchange="updateFileName(this)">
                <span id="file-name">Файл не выбран</span>
            </div>

            <button type="submit" class="btn-submit">Отправить отчет</button>
        </form>
    </div>
</div>
{# Весь остальной CSS и JS оставляем без изменений #}
...