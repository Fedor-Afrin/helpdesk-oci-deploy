name: CI/CD Helpdesk

on:
  push:
    branches:
      - main
      - test
    paths-ignore:
      - "charts/**"
      - ".github/workflows/**"
      - "README.md"
      - ".gitignore"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- ЛОГИКА ТЕГОВ ---
      - name: Generate Docker Tags
        id: meta
        run: |
          # Сохраняем имя пользователя для краткости
          USER="${{ secrets.DOCKERHUB_USERNAME }}"
          SHA="${{ github.sha }}"

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ЕСЛИ MAIN: Делаем два тега (latest и SHA)
            echo "BACKEND_TAGS=$USER/helpdesk-backend:latest,$USER/helpdesk-backend:$SHA" >> $GITHUB_ENV
            echo "FRONTEND_TAGS=$USER/helpdesk-frontend:latest,$USER/helpdesk-frontend:$SHA" >> $GITHUB_ENV
          else
            # ЕСЛИ TEST: Делаем ТОЛЬКО ОДИН тег (test-latest)
            # SHA-тег сюда не попадет
            echo "BACKEND_TAGS=$USER/helpdesk-backend:test-latest" >> $GITHUB_ENV
            echo "FRONTEND_TAGS=$USER/helpdesk-frontend:test-latest" >> $GITHUB_ENV
          fi

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend-app
          push: true
          # Используем сформированную выше переменную
          tags: ${{ env.BACKEND_TAGS }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend-app
          push: true
          # Используем сформированную выше переменную
          tags: ${{ env.FRONTEND_TAGS }}

      # --- ОБНОВЛЕНИЕ HELM (ТОЛЬКО ДЛЯ MAIN) ---
      - name: Update Helm Chart Values
        if: github.ref == 'refs/heads/main'
        run: |
          VALUES_PATH="charts/helpdesk-app/values.yaml"

          yq -i ".backend.tag = \"${{ github.sha }}\"" $VALUES_PATH
          yq -i ".frontend.tag = \"${{ github.sha }}\"" $VALUES_PATH

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          if [[ -n $(git status -s $VALUES_PATH) ]]; then
            git add $VALUES_PATH
            git commit -m "chore: update image tags to ${{ github.sha }} [skip ci]"
            git push
          else
            echo "No changes in values.yaml"
          fi
